name: Set Progress When Issue Created

on:
  issues:
    types: [opened]

# é€™å€‹ block ä½ å¯ä»¥ï¼š
# 1) å®Œå…¨åˆªæ‰ï¼Œæˆ–
# 2) æ”¹æˆ repository-projects
permissions:
  contents: read
  issues: write
  repository-projects: write   # â¬…ï¸ æŠŠåŸæœ¬çš„ projects: write æ”¹æˆé€™è¡Œ

jobs:
  set-progress:
    runs-on: ubuntu-latest

    # é€™é‚ŠæŠŠ PAT æ”¾é€² GH_TOKENï¼Œçµ¦ gh CLI ç”¨
    env:
      GH_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

    steps:
      - name: Show trigger info
        run: |
          echo "Action: ${{ github.event.action }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"

      - name: Add issue to project and set Progress = Todo
        env:
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          echo "Issue node id: $ISSUE_ID"

          echo "ğŸ“Œ å°‡ Issue åŠ å…¥ Projectâ€¦"
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{
                projectId:$project
                contentId:$item
              }) {
                item { id }
              }
            }
          ' -f project=PVT_kwH0ADBtMs4BJYJc -f item="$ISSUE_ID"

          echo "ğŸ“Œ è¨­å®š Progress = Todoâ€¦"
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $option:String!) {
              updateProjectV2ItemFieldValue(input:{
                projectId: $project
                itemId: $item
                fieldId: $field
                value: { singleSelectOptionId: $option }
              }) {
                projectV2Item { id }
              }
            }
          ' \
          -f project=PVT_kwH0ADBtMs4BJYJc \
          -f item="$ISSUE_ID" \
          -f field=PVTSSF_LAHOADBtMs4BJYJczg5j9EA \
          -f option=7434d06d

      - name: Done
        run: echo "ğŸš€ Progress å·²è‡ªå‹•è¨­ç‚º Todoï¼"
