name: Sync GitHub Status to Jira

on:
  issues:
    types: [labeled]

jobs:
  sync-status-to-jira:
    runs-on: ubuntu-latest

    steps:
      # 1. Login to Jira
      - name: Login to Jira
        if: startsWith(github.event.label.name, 'status:')
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 2. 找 jira:<issueKey> 的 label
      - name: Extract Jira issue key from labels
        if: startsWith(github.event.label.name, 'status:')
        id: get_jira_key
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const labels = context.payload.issue.labels || [];
            const jiraLabel = labels.find(l => l.name.startsWith('jira:'));
            if (!jiraLabel) {
              core.setFailed('No jira:<KEY> label found.');
            }
            return jiraLabel.name.replace('jira:', '');

      # 3. 依照 status:* label → 決定 Jira transition
      - name: Decide Jira transition name
        if: startsWith(github.event.label.name, 'status:')
        id: decide_transition
        run: |
          label="${{ github.event.label.name }}"

          case "$label" in
            status:todo)
              echo "transition_name=todo" >> $GITHUB_OUTPUT
              ;;
            status:doing)
              echo "transition_name=doing" >> $GITHUB_OUTPUT
              ;;
            status:stg)
              echo "transition_name=STG" >> $GITHUB_OUTPUT
              ;;
            status:pending)
              echo "transition_name=Pending" >> $GITHUB_OUTPUT
              ;;
            status:uat)
              echo "transition_name=UAT" >> $GITHUB_OUTPUT
              ;;
            status:prod)
              echo "transition_name=Done" >> $GITHUB_OUTPUT
              ;;
            status:rollback)
              echo "transition_name=Rollback" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "transition_name=" >> $GITHUB_OUTPUT
              ;;
          esac

      # 4. 呼叫 Jira 轉換狀態
      - name: Transition Jira issue
        if: startsWith(github.event.label.name, 'status:') && steps.decide_transition.outputs.transition_name != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.get_jira_key.outputs.result }}
          transition: ${{ steps.decide_transition.outputs.transition_name }}
