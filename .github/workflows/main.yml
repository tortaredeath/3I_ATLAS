name: Sync GitHub Status to Jira

on:
  issues:
    types: [labeled]

jobs:
  sync-status-to-jira:
    runs-on: ubuntu-latest

    # 只處理 status: 開頭的 label
    if: startsWith(github.event.label.name, 'status:')

    steps:
      - name: Debug status label
        run: echo "Status label added: ${{ github.event.label.name }}"

      # 1. 先登入 Jira
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 2. 從 GitHub issue 的 labels 找出 jira:<ISSUE_KEY>
      - name: Extract Jira issue key from labels
        id: get_jira_key
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const labels = context.payload.issue.labels || [];
            const jiraLabel = labels.find(l => l.name.startsWith('jira:'));
            if (!jiraLabel) {
              core.setFailed('No jira:<KEY> label found on this issue.');
            }
            const key = jiraLabel.name.replace('jira:', '');
            core.info(`Found Jira key: ${key}`);
            return key;

      # 3. 根據加上的 status label 決定要用哪個 Jira transition
      - name: Decide Jira transition name
        id: decide_transition
        run: |
          label="${{ github.event.label.name }}"
          echo "Label is: $label"

          if [ "$label" = "status:todo" ]; then
            echo "transition_name=To Do" >> $GITHUB_OUTPUT
          elif [ "$label" = "status:doing" ]; then
            echo "transition_name=In Progress" >> $GITHUB_OUTPUT
          elif [ "$label" = "status:done" ]; then
            echo "transition_name=Done" >> $GITHUB_OUTPUT
          else
            echo "Unknown status label, skip Jira transition."
            echo "transition_name=" >> $GITHUB_OUTPUT
          fi

      # 4. 對 Jira issue 做狀態轉換
      - name: Transition Jira issue
        if: steps.decide_transition.outputs.transition_name != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.get_jira_key.outputs.result }}
          transition: ${{ steps.decide_transition.outputs.transition_name }}
