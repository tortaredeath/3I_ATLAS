name: Sync GitHub Status to Jira

on:
  issues:
    types: [labeled]

jobs:
  sync-status-to-jira:
    runs-on: ubuntu-latest

    # 只在 label 名稱以 status: 開頭時執行
    if: ${{ github.event.label.name =~ '^status:' }}

    steps:
      - name: Debug status label
        run: echo "Status label added: ${{ github.event.label.name }}"

      # 1. 先登入 Jira
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 2. 從 labels 找出 jira:KEY
      - name: Extract Jira issue key from labels
        id: get_jira_key
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const labels = context.payload.issue.labels || [];
            const jiraLabel = labels.find(l =>
