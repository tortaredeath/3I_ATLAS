name: Set Progress When Issue Created

on:
  issues:
    types: [opened]

jobs:
  set-progress:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

    steps:
      - name: Show trigger info
        run: |
          echo "Action: ${{ github.event.action }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"

      # å…ˆç¢ºèª GH_PROJECT_TOKEN å°é€™å€‹ PROJECT_ID çœ‹ä¸çœ‹å¾—åˆ°
      - name: Debug â€“ check project node
        run: |
          echo "ğŸ” Checking project node..."
          gh api graphql -f query='
            query($id:ID!) {
              node(id:$id) {
                __typename
                ... on ProjectV2 {
                  title
                  number
                }
              }
            }
          ' -f id="PVT_kwH0ADBtMs4A2aSc"

      - name: Add issue to project and set Progress = Todo
        env:
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          echo "Issue node id: $ISSUE_ID"

          echo "ğŸ“Œ å°‡ Issue åŠ å…¥ Projectâ€¦"
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{
                projectId:$project
                contentId:$item
              }) {
                item { id }
              }
            }
          ' -f project="PVT_kwH0ADBtMs4A2aSc" -f item="$ISSUE_ID"

          echo "ğŸ“Œ è¨­å®š Progress = Todoâ€¦"
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $option:String!) {
              updateProjectV2ItemFieldValue(input:{
                projectId: $project
                itemId: $item
                fieldId: $field
                value: { singleSelectOptionId: $option }
              }) {
                projectV2Item { id }
              }
            }
          ' \
          -f project="PVT_kwH0ADBtMs4A2aSc" \
          -f item="$ISSUE_ID" \
          -f field="PVTSSF_LAHOADBtMs4BJYJczg5j9EA" \
          -f option="7434d06d"

      - name: Done
        run: echo "ğŸš€ Progress å·²è‡ªå‹•è¨­ç‚º Todoï¼"
